---
title: 网络是怎样连接的
sidebarDepth: 2
---

::: tip

一直以来，从输入链接到页面显示内容经历了什么是一个非常常规的面试题，而 《网络是怎样连接的》目录已经很好的回答了这个问题。

:::

<img :src="$withBase('/computer/how-networks-work-1.jpg')" alt="how-networks-work-1">

## 第一章 浏览器生成消息 -- 探索浏览器内部

### 1. 生成 HTTP 请求消息

生成 HTTP 前需要解析 URL：

```bash
# 1. HTTP 协议
http://user:password@www.shanyuhai.top:80/dir/index.html
# user 用户名（可省略）
# password 密码（可省略）
# www.shanyuhai.top Web 服务器域名
# 80 端口（可省略）
# /dir/index.html 文件的路径名

# 2. FTP 协议
ftp://user:password@ftp.shanyuhai.top:21/dir/index.html
# user 用户名（可省略）
# password 密码（可省略）
# ftp.shanyuhai.top FTP 服务器域名
# 21 端口（可省略）
# /dir/index.html 文件的路径名

# 3. 客户端本地文件
file://localhost/home/shanyuhai/project/network/index.html
# localhost 计算机名（可省略）
# /home/shanyuhai/project/network/index.html 文件的路径名

# mailto 邮件
mailto:shanyuhai@shanyuhai.top
# shanyuhai@shanyuhai.top 邮件地址

# news 新闻组
news:comp.protocols.tcp
# comp.protocols.tcp 新闻组名
```

HTTP 主要方法：

|  方法   | 含义                                                         |
| :-----: | ------------------------------------------------------------ |
|   GET   | 获取 URI 指定的信息。如果 URI 指定的是文件，则返回文件的内容；如果 URI 指定的是 [CGI 程序](https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E7%BD%91%E5%85%B3%E6%8E%A5%E5%8F%A3)，则返回该程序的输出数据。 |
|  POST   | 从客户端向服务器发送数据。一般用于发送表单中填写数据等情况。 |
|  HEAD   | 和 GET 基本相同，只不过它只返回 HTTP 的消息头（message header），而不返回数据的内容。用于获取文件最后更新时间等信息。 |
| OPTIONS | 用于通知或查询通信选项。                                     |
|   PUT   | 替换 URI 指定的服务器上的文件。如果 URI 指定的文件不存在，则创建该文件。 |
| DELETE  | 删除 URI 指定的服务器上的文件。                              |
|  TRACE  | 将服务器收到的请求行和头部（header）直接反给客户端。用于在使用代理的环境中检查改写请求的情况。 |
| CONNECT | 使用代理传输加密消息时使用。                                 |

在了解以上基础后就可以生成请求消息了：

```
<方法><空格><URI><空格><HTTP 版本>
<字段名1>:<字段值>
<字段名2>:<字段值>
<字段名n>:<字段值>
<空行>
<消息体>
```

第一行为**请求行**，通过这一行就可以大致了解请求的内容。

第二部分一堆字段名被称为**消息头**，每行包含一个头字段，用于表示请求行的附加信息。消息头的行数根据具体可变，一直延伸到空行为止。

**消息体（message body）** 包含客户端向服务器发送的数据，例如用 POST 方法向服务器发送的网页表单数据。

### 2. 向 DNS 服务器查询 Web 服务器的 IP 地址

 IP 地址类似于你的住址 “xx 栋 xx 单元 xx 室”，找到 IP 地址后就可以将生成的请求发到对应的服务器了。

实际的 IP 地址是一串 32 比特的数字，按照 8 比特（1 字节）为一组分成 4 组，分别用十进制表示然后再用圆点隔开。但仅凭这一串数字是无法得知哪是网络号，哪是主机号，因此我们还需要格外的信息（子网掩码）来表示 IP 地址的内部结构，子网掩码为 1 的部分表示网络号，子网掩码为 0 的表示主机号。

::: danger

为什么说主机号全为 0/1 呢，是因为 `255` 等价于 `11111111`，`0` 等价于 `00000000`。

:::

```bash
# 1.IP 地址主体的表示方式
	10.11.12.13

# 2.采用与 IP 地址主体相同的格式表示子网掩码的方法
	10.11.12.13/255.255.255.0
	 
# 3.采用网络号比特数来表示子网掩码的方法
	10.11.12.13/24
	
# 4.表示子网的地址
	10.11.12.0/24
# 主机号部分的比特全部为 0,这个地址表示的不是单独一台计算机，而是代表整个子网

# 5.表示子网内广播的地址
	10.11.12.255/24
# 主机号部分的比特全部为 1,这个地址表示对整个子网进行广播
```

为了解决人方便记忆域名，机器又能快捷高效找到 IP，引入了 DNS 机制。

浏览器调用操作系统中的 `Socket` 库解析器来处理域名，之后解析器经过网卡向 DNS 发送查询消息（当然解析器也并不具备使用网络收发数据的功能，它是委托给操作系统内部的协议栈来执行），解析器取出 DNS 返回的响应消息中的 IP 地址，并将其写入浏览器指定的内存地址中。**这样浏览器就得到了 IP 地址。**

### 3. 全世界 DNS 服务器的大接力

信息分布在多台 DNS 服务器中，这些 DNS 服务器相互接力配合，从而查找出要查询的信息。

DNS 域名都是用句点来分隔的，比如 `docs.shanyuhai.top`，这里的句点代表了不同的层次结构。在域名中，越靠右的位置表示其层级越高。因此 `top` 域的下一层是 `shanyuhai`，再下一层才是 `docs`。

如何找到 DNS 信息关键在于怎么找到要访问的 Web 服务器归属哪一台 DNS 管理，互联网中存在许多的 DNS 服务器，肯定不能一台台去找，可以根据上一段中描述的层级关系进行查找。也就是说 `docs.shanyuhai.top` 这个域的 DNS 服务器地址需要注册到 `shanyuhai.top` 域的 DNS 服务器地址，而 `shanyuhai.top` 这个域的 DNS 服务器地址需要注册到 `top` 域的 DNS 服务器地址。这样我们就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址。

**实际上，`top` 域上面还有一层，被称为根域，所以完整的域名为 `docs.shanyuhai.top.`，根域就是最后的那个句点。** 不过一般都不写最后的句点，因此根域常常被忽略。虽然作为用户根域没有显示，但根域的 DNS 信息会保存在所有的 DNS 服务器中。

那么 DNS 服务器的接力就很明显了：

```
1. 客户端：计算机向最近的 DNS 服务器查询 `docs.shanyuhai.top` 的 IP 地址
2. 最近的 DNS 服务器：未找到该信息，但我保存了根域 DNS 服务器的地址
3. 根域：我不知道，你可以去 `top` 域问问
4. com 域：我不知道，你可以去 `shanyuhai.top` 域问问
5. shanyuhai.top 域：我也不知道，你可以去 `docs.shanyuhai.top` 域问问
6. Web 服务器：我知道，IP 地址是 xxx.xxx.xxx.xxx
```

不是每一次查询都会走以上步骤，DNS 服务器具有缓存的功能，当在缓存时间内时会直接返回上次查询到的结果。

### 4. 委托协议栈发送消息

生成了 HTTP 请求消息，也知道了 IP 地址，那么就可以委托操作系统内部的协议栈向目标 IP 地址发送数据了。

这个收发数据的操作可以简化为：

1. 创建套接字（创建套接字阶段）

   简单理解为调用 `Socket` 库中的 `socket` 程序就完成了，当然这会返回一个描述符用于区别不同的数据收发操作。

2. 将管道连接到服务器端的套接字上（连接阶段）

   简单理解为调用 `Socket` 库中的 `connect` 程序就完成了。该程序需要指定描述符、服务器 IP 地址和端口号三个参数。

   想要连接到服务器上指定 Web 程序的套接字，而如何知道套接字就又是一个问题了，端口号可以解决该问题。为什么不直接使用服务器的套接字，个人认为套接字是动态变化的，而端口号是可以固定的。

   既然连接服务器的套接字时需要知道其端口号，那客户端的端口号呢？客户端在创建套接字时会，协议栈会随便创建一个端口号，然后将该端口号通知给服务器。

3. 收发数据（通信阶段）

   **发**简单理解为调用 `Socket` 库中的 `write` 程序将数据送入套接字。

   **收**简单理解为调用 `Socket` 库中的 `read` 程序将收到的响应消息放到内存（接收缓冲区）。

4. 断开管道并删除套接字（断开阶段）

   简单理解为调用 `Socket` 库中的 `close` 程序就完成了。最终，连接在套接字之间的管道会断开，套接字本身也会被删除。



## 第二章 用电信号传递 TCP/IP -- 探索协议栈和网卡

### 1. 创建套接字

### 2. 连接服务器

### 3. 收发数据

### 4. 从服务器断开并删除套接字

### 5. IP 与以太网的包收发操作

### 6. UDP 协议的收发操作



## 第三章 从网络到网络设备 -- 搜索集线器、交换机和路由器

### 1. 信号在网线和集线器中传输

### 2. 交换机的包转发操作

### 3. 路由器的包转发操作

### 4. 路由器的附加功能



## 第四章 通过接入网进入互联网内部 -- 探索接入网和网络运营商

### 1. ADSL 接入网的结构和工作方式

### 2. 光纤接入网（FTTH）

### 3. 接入网中使用的 PPP 和隧道

### 4. 网络运营商的内部

### 5. 跨越运营商的网络包



## 第五章 服务器端的局域网有什么玄机

### 1. Web 服务器的部署地点

### 2. 防火墙的结构和原理

### 3. 通过请求平分给多台服务器来平衡负载

### 4. 使用缓存服务器来分担负载

### 5. 内容分发服务



## 第六章 请求到达 Web 服务器，响应返回浏览器 -- 短短几秒的 “漫长旅行” 迎来终点

### 1. 服务器概览

### 2. 服务器的接收操作

### 3. Web 服务器程序解释请求消息并作出响应

### 4. 浏览器响应消息并显示内容

